name: Build and Release JAR with Gradle

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Install Gradle
      run: sudo apt-get update && sudo apt-get install -y gradle

    - name: Generate Gradle Wrapper
      run: gradle wrapper --gradle-version=8.10

    - name: Build with Gradle
      run: ./gradlew clean build

    - name: List all JAR files
      id: list-jars
      run: |
        echo "=== ALL JAR FILES FOUND ==="
        find . -name "*.jar" -type f
        echo "=== BUILD/LIBS CONTENTS ==="
        ls -la build/libs/ || echo "No build/libs directory"
        
        # Find the main application JAR
        MAIN_JAR=$(find build/libs -name "*.jar" ! -name "*plain*" ! -name "*sources*" ! -name "*javadoc*" | head -1)
        if [ -n "$MAIN_JAR" ]; then
          echo "MAIN_JAR=$MAIN_JAR" >> $GITHUB_OUTPUT
          echo "Selected main JAR: $MAIN_JAR"
        else
          echo "No main JAR found, using first JAR"
          FIRST_JAR=$(find build/libs -name "*.jar" | head -1)
          echo "MAIN_JAR=$FIRST_JAR" >> $GITHUB_OUTPUT
        fi

    - name: Upload ALL JAR artifacts
      uses: actions/upload-artifact@v4
      with:
        name: all-jars
        path: build/libs/*.jar
        retention-days: 30

    - name: Upload main JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: main-app-jar
        path: ${{ steps.list-jars.outputs.MAIN_JAR }}
        retention-days: 30

    - name: Create GitHub Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.list-jars.outputs.MAIN_JAR }}
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        body: |
          Automated release from GitHub Actions
          Commit: ${{ github.sha }}
